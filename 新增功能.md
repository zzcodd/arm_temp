# 新增功能
## 目录
- [用户管理](#用户管理)
  - [Handle](#handle)
  - [IdentifyClient](#identifyclient)
  - [Login](#login)
  - [Register](#register)
  - [ResetPassword](#resetpassword)
  - [Logout](#logout)
- [录像日志文件显示](#录像日志文件显示)
  - [GetRecordDateList 和 GetLogDateList](#getrecorddatelist-和-getlogdatelist)
  - [显示时间范围内的录像文件](#显示时间范围内的录像文件)
- [录像日志文件拷贝](#录像日志文件拷贝)
  - [RecordDateCopy](#recorddatecopy)
  - [LogDateCopy](#logdatecopy)
  - [QueryCopyProgress 和 QueryLogCopyProgress](#querycopyprogress-和-querylogcopyprogress)


### 用户权限


| 姓名  | ADMIN |     CIDI |
| :--: | :---: | :------: |
| 登录 |  1  | 1 |
| 注册 |  1  | 1 |
| 删除 |  1  | 0 |
| 修改密码 |  1  | 0 |
| 录像查询 |  1  | 1 |
| 录像拷贝usrdisk |  `./bag/ ./camera/full ./camera/key ` |  `./camera/full ./camera/key` |
| 录像拷贝Internaldisk |  `./bag/ ./camera/full ./camera/key `  | 0 |




### 用户管理
#### Handle
- 识别客户端类型：`ADMIN` `CIDI`
- 获取会话令牌：`session_token`
- 验证会话令牌：
  - 如果`令牌无效`，检查是否注册，如果未注册且不是注册指令，返回提示注册
  - 如果用户未注册是注册指令，调用Register进行注册
  - 如果用户已注册是登录指令，调用Login进行登录
- 根据客户端类型调用相应的PickHandle函数处理指令。（此处都是同一个PickHandle函数，如果后续进行权限控制，可以从这修改）
```cpp
    //处理命令
    if(CLIENT_UNKNOWN == type) {
      AINFO << "Handling as CLIENT_UNKNOWN.";
      code = PickHandle(cmd, map, out_msg);
    } else if(CLIENT_ADMIN == type) {
      AINFO << "Handling as CLIENT_ADMIN.";
      //TODO
      code = PickHandle(cmd, map, out_msg);
    } else if(CLIENT_CIDI == type) {
      AINFO << "Handling as CLIENT_CIDI.";
      //TODO
      code = PickHandle(cmd, map, out_msg);
    }
```

#### IdentifyClient
- 内置cidi 和 admin 为 `CLIENT_ADMIN`， 新注册的用户默认设置为 `CLIENT_CIDI`

#### Login
```Json
curl -d '{ "cmd_type": "login", "username": "cidi", "password": "c4ca4238a0b923820dcc509a6f75849b"}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":{"role":"CLIENT_CIDI","session_token":"7038u795szC9R2IWF9dCC7487V5jDy4S","stream_url":"ws://svm.pingtai.cidiserver.com:41001"},"result_code":0,"result_msg":"Login successful."}
```

#### Register
```Json
curl -d '{ "cmd_type": "register", "username": "new_uesr", "password": "7096574cebeb85403bd77a8f6cbe151f","email":"test@qq.com"}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":"{}","result_code":0,"result_msg":"Registration successful."}
```

#### ResetPassword
```Json
curl -d '{ "cmd_type": "reset_password", "username": "new_user", "password": "7096574cebeb85403bd77a8f6cbe151f","new_password":"21f3d99c69e2f2fe16d29a04846bc1ed" ,"email":"test@qq.com","session_token":""}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":"{}","result_code":0,"result_msg":"Password has been reset successfully."}
```

#### DeleteUser
```Json
curl -d '{ "cmd_type": "delete", "username": "cidi", "password": "c4ca4238a0b923820dcc509a6f75849b","delete_username":"new_user"}' http://172.16.133.63:8081/apiserver/cmd

```

#### Logout
- 在已登录的基础上删除会话
```Json
curl -d '{ "cmd_type": "logout", "session_token":""}' http://172.16.133.63:8081/apiserver/cmd

{"data_map":"{}","result_code":0,"result_msg":"Logout successful"}
```


### 录像日志文件显示
![recordTree](https://github.com/zzcodd/ImageHosting/blob/main/record_tree.png?raw=true)

#### GetRecordDateList 和 GetLogDateList
- 列出有录像或日志文件的日期的列表
- 录像： /bag/  /camera/full/  /camera/key/
- 日志: /ips/  /lte/
  ```cpp
    函数一：0/1表示flag
    RecordLog(type, root_path, size, free_size, vec, 0);
    if (CLIENT_ADMIN == client_type) {
      RecordLog(type, root_path, size, free_size, vec, 1);
    }

    函数二：0/1表示yy
    if(flag == 1){
      GetCopyDateList(root_path + "/bag/", 0, vec);
    }
    GetCopyDateList(root_path + "/camera/full/", 0, vec);
    GetCopyDateList(root_path + "/camera/key/", 1, vec);

    函数三：
    if (1 == yy) item.type = "alarm"; 
    else item.type = "time";
  ```

#### 显示时间范围内的录像文件

- ***ShowRecordDateList***
  ：显示某一天的全部录像文件(`.avi` `.jpg`)
  ```
  curl -d '{ "cmd_type": "show_record_date_list",
  "date":"20230901"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":{"file_count":4,"file_list":[{"file":"20230901103724228.res.avi","folder":"20230901//.res"},{"file":"20230901103724569.near.avi","folder":"20230901//6mm"},{"file":"20230901103730021.jpg","folder":"20230901//6mm"},{"file":"20230901103800014.jpg","folder":"20230901//6mm"}]},"result_code":0,"result_msg":"Query success"}
  ```

- ***ShowRecordDateListWithoutJPG***
  ：显示某一天的全部录像文件( `.avi`)

- ***ShowRecordDateListWithTimeFilter***
  : 显示某一天一个时间段的全部录像文件(`.avi` `.jpg`)
  ```
  curl -d '{ "cmd_type": "show_record_date_list_range","date":"20221215190000|20221215190200"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":{"file_count":6,"file_list":[{"file":"20221215190029716.near.avi","folder":"20221215//6mm"},{"file":"20221215190129708.near.avi","folder":"20221215//6mm"},{"file":"20221215190000031.jpg","folder":"20221215//6mm"},{"file":"20221215190030028.jpg","folder":"20221215//6mm"},{"file":"20221215190100026.jpg","folder":"20221215//6mm"},{"file":"20221215190130024.jpg","folder":"20221215//6mm"}]},"result_code":0,"result_msg":"Query success"}
  ```

- ***ShowRecordDateListWithoutJPGWithTimeFilter***
  : 显示某一天一个时间段的全部录像文件(`.avi`)

- ***ShowLogDateList***:显示某一天的录像文件
  ```
  curl -d '{ "cmd_type": "get_log_date_list"}' http://172.16.133.63:8081/apiserver/cmd

  {"data_map":[{"name":"20240715","type":"time"},{"name":"20240716","type":"time"},{"name":"20240717","type":"time"},{"name":"20240718","type":"time"},{"name":"20240719","type":"time"},{"name":"20240720","type":"time"},{"name":"20240721","type":"time"},{"name":"20240722","type":"time"},{"name":"20240723","type":"time"},{"name":"20240724","type":"time"},{"name":"20240725","type":"time"},{"name":"20240726","type":"time"},{"name":"20240727","type":"time"},{"name":"20240728","type":"time"},{"name":"20240729","type":"time"},{"name":"20240730","type":"time"},{"name":"20240731","type":"time"},{"name":"20240801","type":"time"},{"name":"20240802","type":"time"},{"name":"20240803","type":"time"},{"name":"20240804","type":"time"},{"name":"20240805","type":"time"},{"name":"20240806","type":"time"},{"name":"20240807","type":"time"},{"name":"mcu_log","type":"time"}],"result_code":0,"result_msg":"successful"}
  ```
  
  #### 对应指令
  - HANDLE_CMD("get_record_date_list", GetRecordDateList);
  - HANDLE_CMD("get_log_date_list", GetLogDateList);
  - HANDLE_CMD("show_record_date_list", ShowRecordDateList);
  - HANDLE_CMD("show_record_date_list_noJPG"，  ShowRecordDateListWithoutJPG);
  - HANDLE_CMD("show_record_date_list_range", ShowRecordDateListWithTimeFilter);
  HANDLE_CMD("show_record_date_list_range_noJPG" ,ShowRecordDateListWithoutJPGWithTimeFilter);
  - HANDLE_CMD("show_log_date_list", ShowLogDateList);
  
### 录像日志文件拷贝
- ***RecordDateCopy*** 
  - 修改了拷贝的逻辑
    - 以前是：将拷贝任务添加到一个新启动线程中，新线程处理拷贝逻辑
  由单线程拷贝变成多线程，每个线程分配10个拷贝任务。
    - 将拷贝任务添加到一个新启动的线程中，新线程只负责处理拷贝逻辑，真正拷贝过程由多线程处理，以10个拷贝任务一组启动新线程。
  - 不同的拷贝权限
    - 以前：CLIENT_ADMIN 无拷贝权限
    ```C++
    if (0 == type) {
      usrdisk_rec = GetRecordPathAndSize(LOCAL_RECORD_PATH, path, size, free_s);
    if (usrdisk_rec) {
      if (CLIENT_ADMIN == client_type)
        AppendRecordCopyFromPath(path + "/bag/", true, name_list, false);
        AppendRecordCopyFromPath(path + "/camera/full/", false, name_list, true);
        AppendRecordCopyFromPath(path + "/camera/key/", false, name_list, true);
      }
    }
    ```
    - CLIENT_ADMIN身份，还需要拷贝到内部磁盘
    ```C++
    if (CLIENT_ADMIN == client_type) {
    path = "";
    if (0 == type) {
      size = free_s = 0L;
      rec = GetRecordPathAndSize("internaldisk", path, size, free_s);
      if (rec) {
        if (!usrdisk_rec) {
          AppendRecordCopyFromPath(path + "/bag/", true, name_list, false);
          AppendRecordCopyFromPath(path + "/camera/full/", true, name_list,
              true);
          AppendRecordCopyFromPath(path + "/camera/key/", true, name_list,
              true);
        }
      }
      }
    }
    ```
    - 现在是默认只拷贝`/6mm/` 和隐藏目录`/.res/` 中`.avi `和 `.mp4`结尾的数据

- ***LogDateCopy***
- ***QueryCopyProgress 和 QueryLogCopyProgress***


  #### 对应指令
  - HANDLE_CMD("record_range_copy", RecordDateCopy);
  - HANDLE_CMD("log_date_copy", LogDateCopy);
  - HANDLE_CMD("get_copy_progress", QueryCopyProgress);
  - HANDLE_CMD("get_log_copy_progress", QueryLogCopyProgress);